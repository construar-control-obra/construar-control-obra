<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Presupuesto</title>
  <style>
    body{font-family:Arial;background:#f6f7fb;margin:0;padding:20px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:18px 20px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:14px}
    a{color:#6a00ff;text-decoration:none}
    select,input{padding:10px;border:1px solid #ddd;border-radius:12px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:end}
    .row > div{flex:1;min-width:160px}
    button{padding:12px 14px;border:0;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .pill{display:inline-block;padding:10px 12px;border-radius:14px;background:#f1f5ff;border:1px solid #dbe7ff}
    .muted{color:#666}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h1>üìë Presupuesto</h1>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div style="margin-top:12px">
            {% for cat,msg in messages %}
              <div style="padding:10px;border-radius:10px;margin:6px 0;background:#f1f5ff;border:1px solid #dbe7ff">
                {{ msg }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <form method="get" class="row">
        <div>
          <label>Obra</label><br>
          <select name="obra_id" onchange="this.form.submit()">
            <option value="">-- Selecciona --</option>
            {% for o in obras %}
              <option value="{{o.id}}" {% if obra_sel and obra_sel.id==o.id %}selected{% endif %}>{{o.nombre}}</option>
            {% endfor %}
          </select>
        </div>
      </form>

      {% if obra_sel %}
        <p style="margin-top:12px" class="pill">
          Obra: <b>{{obra_sel.nombre}}</b> | Total Presupuesto: <b>{{"%.2f"|format(total)}}</b>
        </p>

        <form method="post" class="row" style="margin-top:12px">
          <input type="hidden" name="obra_id" value="{{obra_sel.id}}">
          <div>
            <label>Partida</label><br>
            <input name="partida" placeholder="Ej. Cimentaci√≥n" required>
          </div>
          <div>
            <label>Descripci√≥n</label><br>
            <input name="descripcion" placeholder="Ej. Excavaci√≥n + plantilla" required>
          </div>
          <div>
            <label>Cantidad</label><br>
            <input name="cantidad" inputmode="decimal" placeholder="0.00">
          </div>
          <div>
            <label>P. Unitario</label><br>
            <input name="precio_unitario" inputmode="decimal" placeholder="0.00">
          </div>
          <div style="min-width:140px">
            <button type="submit">Agregar</button>
          </div>
        </form>

        <table>
          <thead>
            <tr>
              <th>Partida</th>
              <th>Descripci√≥n</th>
              <th>Cantidad</th>
              <th>P.Unit</th>
              <th>Importe</th>
            </tr>
          </thead>
          <tbody>
            {% for p in partidas %}
            <tr>
              <td>{{p.partida}}</td>
              <td>{{p.descripcion}}</td>
              <td>{{"%.2f"|format(p.cantidad or 0)}}</td>
              <td>{{"%.2f"|format(p.precio_unitario or 0)}}</td>
              <td>{{"%.2f"|format((p.cantidad or 0)*(p.precio_unitario or 0))}}</td>
            </tr>
            {% endfor %}
            {% if partidas|length == 0 %}
            <tr><td colspan="5" class="muted">Sin partidas a√∫n.</td></tr>
            {% endif %}
          </tbody>
        </table>
      {% else %}
        <p class="muted">Selecciona una obra para ver y capturar su presupuesto.</p>
      {% endif %}

      <p style="margin-top:14px"><a href="/">‚Üê Volver al inicio</a></p>
    </div>

  </div>
</body>
</html>



