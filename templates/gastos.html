<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gastos</title>
  <style>
    body{font-family:Arial;background:#f6f7fb;margin:0;padding:20px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:16px;padding:18px 20px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:14px}
    a{color:#6a00ff;text-decoration:none}
    select,input,textarea{padding:10px;border:1px solid #ddd;border-radius:12px;width:100%}
    textarea{min-height:44px}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:end}
    .row > div{flex:1;min-width:180px}
    button{padding:12px 14px;border:0;border-radius:12px;background:#111;color:#fff;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;vertical-align:top}
    .pill{display:inline-block;padding:10px 12px;border-radius:14px;background:#f1f5ff;border:1px solid #dbe7ff}
    .muted{color:#666}
    .img{max-width:140px;border-radius:12px;border:1px solid #eee}
    .flash{padding:10px;border-radius:10px;margin:6px 0;background:#f1f5ff;border:1px solid #dbe7ff}
    .flash.warn{background:#fff7e6;border-color:#ffe2a8}
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h1>üí∏ Gastos</h1>
      <div class="muted">Captura gastos por d√≠a por obra (desde el celular) y sube foto del ticket (m√°x 3MB).</div>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div style="margin-top:12px">
            {% for cat,msg in messages %}
              <div class="flash {% if cat in ['warning','danger'] %}warn{% endif %}">{{ msg }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <form method="get" class="row" style="margin-top:12px">
        <div>
          <label>Obra</label>
          <select name="obra_id" onchange="this.form.submit()">
            <option value="">-- Selecciona --</option>
            {% for o in obras %}
              <option value="{{o.id}}" {% if obra_sel and obra_sel.id==o.id %}selected{% endif %}>{{o.nombre}}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Fecha (filtro)</label>
          <input type="date" name="fecha" value="{% if fecha_sel %}{{ fecha_sel.strftime('%Y-%m-%d') }}{% endif %}" onchange="this.form.submit()">
        </div>
      </form>

      {% if obra_sel %}
        <p style="margin-top:12px" class="pill">
          Obra: <b>{{obra_sel.nombre}}</b>
          {% if fecha_sel %} | D√≠a: <b>{{fecha_sel.strftime('%Y-%m-%d')}}</b>{% endif %}
          | Total mostrado: <b>{{"%.2f"|format(total)}}</b>
        </p>

        <form method="post" enctype="multipart/form-data" class="row" style="margin-top:12px">
          <input type="hidden" name="obra_id" value="{{obra_sel.id}}">

          <div style="min-width:160px">
            <label>Fecha</label>
            <input type="date" name="fecha" value="{% if fecha_sel %}{{ fecha_sel.strftime('%Y-%m-%d') }}{% endif %}" required>
          </div>

          <div>
            <label>Concepto</label>
            <input name="concepto" placeholder="Ej. Cemento / Mano de obra / Gasolina" required>
          </div>

          <div>
            <label>Proveedor</label>
            <input name="proveedor" placeholder="Ej. Construrama / Ferreter√≠a">
          </div>

          <div style="min-width:160px">
            <label>Monto</label>
            <input name="monto" inputmode="decimal" placeholder="0.00">
          </div>

          <div>
            <label>Nota</label>
            <textarea name="nota" placeholder="Ej. Pago de flete / material para frente 2"></textarea>
          </div>

          <div style="min-width:220px">
            <label>Foto ticket (opcional, m√°x 3MB)</label>
            <input type="file" name="ticket" accept="image/*">
          </div>

          <div style="min-width:140px">
            <button type="submit">Guardar</button>
          </div>
        </form>

        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Concepto</th>
              <th>Proveedor</th>
              <th>Monto</th>
              <th>Nota</th>
              <th>Ticket</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for g in gastos %}
            <tr>
              <td>{{ g.fecha.strftime('%Y-%m-%d') if g.fecha else '-' }}</td>
              <td>{{ g.concepto }}</td>
              <td>{{ g.proveedor or '-' }}</td>
              <td>{{ "%.2f"|format(g.monto or 0) }}</td>
              <td>{{ g.nota or '-' }}</td>
              <td>
                {% if g.foto_url %}
                  <a href="{{g.foto_url}}" target="_blank"><img class="img" src="{{g.foto_url}}" alt="ticket"></a>
                {% else %}
                  <span class="muted">Sin foto</span>
                {% endif %}
              </td>
              <td><a href="/gastos/{{g.id}}/editar">Editar</a></td>
            </tr>
            {% endfor %}
            {% if gastos|length == 0 %}
            <tr><td colspan="7" class="muted">Sin gastos a√∫n.</td></tr>
            {% endif %}
          </tbody>
        </table>

      {% else %}
        <p class="muted" style="margin-top:10px">Selecciona una obra para capturar gastos.</p>
      {% endif %}

      <p style="margin-top:14px"><a href="/">‚Üê Volver al inicio</a></p>
    </div>

  </div>
</body>
</html>

